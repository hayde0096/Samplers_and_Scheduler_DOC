# サンプラー（Sampler）とスケジューラ（Scheduler）の解説と分類

本ドキュメントは Stable Diffusion で頻出するサンプラーとスケジューラを整理し、「似た内容をまとめて把握する」ことを重視しています。まず命名規約を確認し、続いて各ファミリーの特徴を学び、最後にスケジューラと利用シーンを組み合わせて素早く参照できるようにしました。

## ドキュメント概要

- サンプラーの役割を理解するには、まず拡散モデル（diffusion model）の基礎を把握しましょう。
  - 推論はランダムノイズから始まり、段階的に「脱ノイズ」して最終画像を得ます。
  - ここでは詳細チュートリアルではなく、要点のメモに留めます。
- サンプラーとスケジューラの役割分担を整理します。
  - **サンプラー**
    - 生成過程で「どのように段階的に画像を復元するか」を定義する戦略群です。
    - 各ステップの計算手順を決め、数値安定性・速度・細部・スタイル一貫性などの特性が変化します。
    - つまりサンプラーは生成が進む*経路*を決め、ディテール・シャープさ・ノイズ制御・全体の作風に影響します。
  - **スケジューラ**
    - **拡散過程のタイムステップをどう配分するか**を決め、ノイズから画像に至る去ノイズ手順を割り当てます。
    - サンプラーが「どう進むか」、スケジューラが「どのステップをどれだけ踏むか」を担当します。
  - 要するに、**スケジューラが時間割を作り、サンプラーが動き方を定義する**関係で、両者が安定性・速度・品質を決めます。

## サンプラーのメモ

- サンプラーはノイズを徐々に画像へ戻し、速度・細部・安定性・多様性に影響します。
  - 低次ソルバ（Euler, DPM Fast）は計算が軽く高速反復向き。高次 / SDE / Heun 系（DPM++, Heun, LMS）は細部に強い反面遅くなります。
  - ステップ数が増えるほどスケジューラ（ノイズ減衰カーブ）の影響が大きくなり、良い組み合わせなら同じステップでも質感や構造が向上します。

## よく使われる接尾辞

- `_ancestral`：アンサストラル（祖先）サンプリングを導入し、ランダム性と多様性を強化。
- `_cfg_pp` / `cfg++`：CFG++ を実装し、低ガイダンス時のオフマニフォールド問題を軽減。
- `_sde`：確率微分方程式ベースのソルバで、より豊かな質感とランダム性を付与。
- `_gpu`：GPU 最適化版 or 並列実装。
- `_alt`：別の数値積分方式。
- `_heun`：Heun 積分器を使い、滑らかさとノイズ抑制を向上。
- `_2m` / `_3m`：高次の多段多項式ソルバ。精度は高いが遅い。
- `seeds_2` / `seeds_3`：複数シードを並列実行 or 結果を融合。

## サンプラーファミリー早見表

| ファミリー / テーマ | 代表的なサンプラー | 主な特徴 | 推奨シナリオ |
| --- | --- | --- | --- |
| Euler | `euler`, `euler_ancestral`, `euler_cfg_pp`, `euler_dy` | 低次・高速・探索向き | ラフスケッチ、PoC、低ステップ検証 |
| Heun | `heun`, `heunpp2` | 改良積分、滑らか・安定だが遅い | クリーンなライン / ノイズ抑制 |
| DPM / DPM++ | `dpm_2/_a`, `dpmpp_2m/3m`, `dpmpp_sde`, `_heun`, `_cfg_pp` | 高精度・写実・多彩なバリアント | 高品質写実、SDXL、精緻素材 |
| LMS / PLMS | `lms`, `plms` | 写実・安定・高ステップ適性 | 写真調、構造安定が欲しい場合 |
| DDIM / UniPC | `ddim`, `uni_pc`, `uni_pc_bh2` | 少ステップ効率、統一ソルバ | 少ステップでの細部確保、比較実験 |
| DDPM | `ddpm` | 最も安定だが最も遅い | 研究、極端に安定重視のフロー |
| IPNDM | `ipndm`, `ipndm_v` | 反復精緻化 | 極限の細部 / 精度 |
| DEIS / Restart / Res Multistep | `deis`, `restart`, `res_multistep*` | 多段復元、`_ancestral/_cfg_pp` と合成可 | 安定性を高める多段戦略 |
| LCM | `lcm` | 潜在空間の制御 | 強制約、段階的特徴制御 |
| 勾配推定系 | `gradient_estimation`, `*_cfg_pp` | 勾配補正 | ピンポイント最適化 / 研究用途 |
| 特殊 / 実験 | `er_sde`, `seeds_2/3`, `sa_solver*` | カスタム or 実験ソルバ | プロジェクト固有 / スタイル実験 |

## ファミリー別詳細

### Euler ファミリー（速度優先）

- **メンバー**：`euler`, `euler_cfg_pp`, `euler_ancestral`, `euler_ancestral_cfg_pp`, `euler_dy`, `euler_smea_dy`, `euler_negative`, `euler_dy_negative`
- **特徴**：最もシンプルな Euler 積分に基づき計算コストが低い。`_ancestral` はランダム性、`*_cfg_pp` は CFG++ 補正、`euler_dy` / `smea_dy` は動的ステップや塗り感、`*_negative` はネガティブ補正でスタイルや安定性を制御。
- **推奨**：高速探索・コンセプトラフ・速度重視の場面。細部が欲しければ DPM++ / LMS / Heun へ。

### Heun ファミリー（滑らか & 安定）

- **メンバー**：`heun`, `heunpp2`
- **特徴**：Heun 改良積分で遷移が滑らかになりノイズも減少。`heunpp2` は高次 or エンジニアード版。`heun` の速度はかなり遅め。
- **推奨**：クリーンなエッジや滑らかなグラデーションを求め、速度は二の次という場面。`smooth` や `beta` などスムーズ系スケジューラとの相性が良い。

### DPM / DPM++ ファミリー（精度と写実）

- **代表例**：`dpm_2`, `dpm_2_ancestral`, `dpm2_a`, `dpm_fast`, `dpm_adaptive`, `dpmpp_2s_ancestral`, `dpmpp_sde`, `dpmpp_sde_gpu`, `dpmpp_2m/_3m` と `_alt`, `_cfg_pp`, `_sde`, `_heun`, `_gpu` などの組み合わせ
- **特徴**：主流の高品質サンプラー。ソルバ次数と SDE / Heun / CFG++ の組み合わせで速度・細部・安定性を細かく調整できる。
- **推奨**：写実系、大規模モデル（SDXL）や精緻なテクスチャ / 一貫性が求められる案件。余裕があれば `dpmpp_2m/3m` と Heun or SDE 版を優先。

### LMS / PLMS（写実志向）

- **メンバー**：`lms`, `plms`
- **特徴**：ラプラシアンピラミッド的発想で構造に強い。高ステップと組み合わせるとクリーンで自然な結果に。
- **推奨**：写真調や構造の安定性が最優先の用途。`karras` / `kl_optimal` スケジューラとの相性が良い。

### DDIM / UniPC / PLMS（品質と効率の両立）

- **メンバー**：`ddim`, `uni_pc`, `uni_pc_bh2`, 実装によっては `plms`
- **特徴**：DDIM は速度と忠実度のバランス型。UniPC は少ステップでも細部を保つ新しい統一ソルバ。
- **推奨**：ステップ数が限られるがディテールを残したいワークフロー。比較実験や反転処理の基準にもよく使われる。

### DDPM / オリジナル拡散

- **メンバー**：`ddpm`
- **特徴**：最初期の拡散サンプラー。最も遅いが抜群に安定。
- **推奨**：研究・古典論文の再現・超安定を要する工程。

### IPNDM / IPNDM_V（反復精緻化）

- **メンバー**：`ipndm`, `ipndm_v`
- **特徴**：多段の反復精緻化で計算負荷は大きいが更なる細部を狙える。
- **推奨**：極限のディテールや素材別の高精度案件。

### DEIS / Restart / Res Multistep（多段回復）

- **メンバー**：`deis`, `restart`, `res_multistep`, `res_multistep_cfg_pp`, `res_multistep_ancestral`, `res_multistep_ancestral_cfg_pp`
- **特徴**：多段回復・再スタート・差分戦略で安定性を底上げ。`_ancestral` `_cfg_pp` とも組み合わせ可能。
- **推奨**：長いシーケンスで安定を保ちつつ、中盤以降にランダム性を再注入したいフロー。

### LCM（潜在制御）

- **メンバー**：`lcm`
- **特徴**：潜在空間で特徴が現れる順序を細かく制御。
- **推奨**：強い制約があるタスク、途中介入したい構図。

### 勾配 / 推定系サンプラー

- **メンバー**：`gradient_estimation`, `gradient_estimation_cfg_pp`
- **特徴**：勾配推定や補正項を明示的に利用し、生成方向を調整。
- **推奨**：研究用途や特定属性の最適化。

### 特殊 / 実験的サンプラー

- **メンバー**：`er_sde`, `seeds_2`, `seeds_3`, `sa_solver`, `sa_solver_pece` など
- **特徴**：プロジェクト固有や実験的な機能。複数シード融合（`seeds_2/3`）、シミュレーテッドアニーリング（`sa_solver*`）、スタイルプリセット等。
- **推奨**：専用スタイル、実験フロー、結果の融合といった高度用途。

## CFG++ / `_cfg_pp` の解説

- **背景**：標準 CFG は posterior mean を復元する際に条件付きノイズ $\epsilon^c$ を使うため、低ガイダンスや DDIM 反転では生成軌道がデータ多様体から外れがちです。
- **修正**：CFG++ は Tweedie 公式で再ノイズ化するときに無条件ノイズ $\epsilon^\varnothing$ を用い、軌道を滑らかにしてデータ多様体に近づけます。
- **利点**：
  - 低ガイダンススケールでも安定し、モード崩壊や白飛びを避けられます。
  - DDIM 反転 / 編集の可逆性が上がり、誤差が減ります。
  - PF-ODE / 生成軌道が直線的になり調整しやすくなります。
- **実用ヒント**：
  - `_cfg_pp`, `cfg++`, `cfgpp` などの名前が付いていれば多くがこの実装ですが、細部はプロジェクト依存です。
  - `ddim`, `dpmpp_*`, `uni_pc` と組み合わせると、CFG ≈2 の低ガイダンスでも十分な結果が得られます。より強い制御が必要なら段階的に上げましょう。
  - 蒸留 / 加速モデル（SDXL Turbo, Lightning 等）では特に効果的です。
- **実装上の注意**：クリップやスケールなど追加の安定化処理が入る場合があります。利用前に README やソースでパラメータを確認してください。

## サンプラー選択ガイド

- **速度 / ラフ制作**：`euler` 系 or `dpm_fast` を優先。
- **高品質写実**：`dpmpp_2m/3m`, `lms`, `plms`, `ddim`（`karras` / `kl_optimal` とセット）。
- **多様性 / 実験**：`_ancestral`, `_sde`, `restart` 系を選択。
- **滑らかさと安定性**：`heun`, `heunpp2`, `dpmpp_*_heun`。
- **少ステップで細部復元**：`ddim`, `uni_pc`, `plms`。

## スケジューラの解説と推奨

### スケジューラの役割

スケジューラはサンプリング中のノイズ減衰方法を決めます。サンプラーと組み合わせることで、同じステップ数でも細部表現・収束速度・ランダム性を調整できます。代表例は以下の通りです。

### 基本 / バランス系

- `simple`：線形減衰。クイックテストやラフ段階向けで Euler / DPM Fast と組み合わせることが多い。
- `normal`：`simple` よりバランスの取れた時間割で、汎用シーンやベースラインに適用。
- `linear_quadratic`：前半は線形、後半は二次で、フェーズごとの比重を変えやすい。

### 細部 / 高周波重視

- `karras`：後半にステップ長を多く割き、少ステップでも高周波を保持。`ddim`, `dpmpp_*`, `uni_pc`, `lms` と好相性。
- `kl_optimal`：KL ダイバージェンスを最小化する「最適」減衰。写実・精細タスクの第一候補。
- `beta`（`beta_1_1` 含む）：Beta 分布ベースで細部と安定を両立。`beta_1_1` は均一版で比較実験に便利。

### ランダム性 / 多様性志向

- `sgm_uniform`：各ステップの重要度を均一化し、全体のランダム性を整える。安定した漸進生成に最適。
- `ddim_uniform`：DDIM フレームワーク内で均一な時間割。再現性や比較に役立つ。
- `exponential`：指数減衰で前半に構造を素早く固め、速度重視の場面に向く。

### フェーズ制御

- `ays`, `ays+`, `ays_30`, `ays_30+`：Align Your Steps 系。重要ステップを揃えて特定フェーズを集中最適化。`30` 版は 30 ステップ前提、`+` は追加制御を提供。
- `gits`：Generate In Transition Steps。遷移ステップで重要ディテールを生成し、`ddim` / `euler` との組み合わせでシャープな構造を得やすい。

### 滑らかさ / Heun 向け

- `smooth`：穏やかな減衰で少ステップ時のノイズ跳ねを抑制。Heun や `dpmpp_*_heun` と好相性。

## スケジューラ早見

- **少ステップでも細部**：`karras`, `kl_optimal`, `beta`
- **速度と安定の両立**：`simple`, `ddim_uniform`, `sgm_uniform`
- **フェーズ制御**：`ays*`, `gits`
- **滑らかさ最優先**：`smooth`, `beta`（特に Heun 系と）

## シナリオ別推奨セット

| シナリオ | サンプラー | スケジューラ | CFG の目安 |
| --- | --- | --- | --- |
| 高速ラフ / コンセプト探索 | `euler` 系 or `dpm_fast` | `simple` / `ddim_uniform` | 5.0~6.0 |
| 高品質写実（SD1.5・高ステップ） | `dpmpp_2m` / `plms` / `ddim` | `karras` / `kl_optimal` | 7.0~8.0 |
| 高品質写実（SDXL＋効率） | `dpmpp_3m_sde_heun` / `dpmpp_2m_sde_heun` | `karras` / `beta` | 5.5~7.0 |
| イラスト / カートゥーン（線画＋塗り） | `ddim` / `plms` / `dpmpp_2m` | `karras` / `ays` / `gits` | 6.5~7.5 |
| スタイル実験 / 多様性 | `_ancestral` or `_sde` 系、`restart` | `sgm_uniform` / `beta` / `exponential` | 5.5~7.0 |
| 複数 LoRA の積み合わせ / 汎用 | `*_cfg_pp` | `kl_optimal` / `simple` | 1~2 |

> CFG 値はモデルやプロンプトの複雑さで変わります。表はヒューリスティックな初期値なので、見た目を確認しながら微調整してください。
>
> 最近は LoRA を多段で重ねる関係で各種 CFGPP 系サンプラーを好んで使っています。CFG ≈2 でも焼けた絵になりにくく良好な結果が得られますが、`karras` スケジューラとの相性はあまり良くありません。
